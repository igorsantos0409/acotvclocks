<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8" />
    <link id="theme-style" rel="stylesheet" href="style.css">
    <title>Relógios TV ACO</title>
</head>

<body>

    <div class="top-bar">
        <div class="top-item" id="dateBox">--</div>
        <div class="top-item" id="weatherBox">Carregando...</div>
        <div class="top-item">
            <img src="aco-logo.svg" alt="Logo ACO" style="height:75px">
        </div>
    </div>

    <div id="clockContainer">

        <div class="showVideo" style="display: none;" id="videoDiv" onclick="videoClick()">
            <!-- <video autoplay loop muted>
                <source src="acoMovie.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video> -->
            <!-- versão com o video do youtube com iframe sem controles e em loop https://www.youtube.com/JLyjd_MjBPQ -->
            <iframe width="560" height="315" src="https://www.youtube.com/embed/JLyjd_MjBPQ?si=7t-iT1YHJeFrgJJK" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
        </div>
        <div class="showClocks">
            <!-- LINHA DE CIMA -->
            <div class="clock-row-up">
                <div class="clock-container big ptContainer" onclick="portugalClick()" id="clock-ptContainer">
                    <canvas id="clock-pt" width="300" height="300"></canvas>
                    <div class="labelbig">Portugal</div>
                </div>

                <div class="clock-container big esContainer" onclick="spainClick()" id="clock-esContainer">
                    <canvas id="clock-es" width="300" height="300"></canvas>
                    <div class="labelbig">Espanha</div>
                </div>
            </div>

            <!-- LINHA DE BAIXO -->
            <div class="clock-row-down">
                <div class="clock-container-small brContainer" id="clock-brContainer">
                    <canvas id="clock-br" width="200" height="200"></canvas>
                    <div class="label">Brasil</div>
                </div>

                <div class="clock-container-small clContainer" id="clock-clContainer" onclick="chileClick()">
                    <canvas id="clock-cl" width="200" height="200"></canvas>
                    <div class="label">Chile</div>
                </div>

                <div class="clock-container-small coContainer" id="clock-coContainer">
                    <canvas id="clock-co" width="200" height="200"></canvas>
                    <div class="label">Colombia</div>
                </div>

                <div class="clock-container-small peContainer" id="clock-peContainer">
                    <canvas id="clock-pe" width="200" height="200"></canvas>
                    <div class="label">Perú</div>
                </div>

                <div class="clock-container-small arContainer" id="clock-arContainer">
                    <canvas id="clock-ar" width="200" height="200"></canvas>
                    <div class="label">Argentina</div>
                </div>
            </div>
        </div>


    </div>

    <h3 id="eta">ETA: carregando...</h3>
    <video id="keepAliveVideo"
       autoplay
       loop
       muted
       playsinline
       preload="auto"
       style="position:fixed;width:100px;height:100px;opacity:1
       ;pointer-events:none;">
  <source src="blank.mp4" type="video/mp4">
</video>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const isDarkMode = urlParams.get('darkMode') === '1';
        const showVideo = urlParams.get('showVideo') === '1';

        if (isDarkMode) document.getElementById("theme-style").href = "dark.css";
        const isDigital = urlParams.get('digital') === '1';
        const apiKeyWeather = urlParams.get('apiKey');

        /********** Relógios **********/
        const countries = [
            { id: 'clock-pt', lang: 'en-US' ,tz: 'Europe/Lisbon', lb: 'Portugal' },
            { id: 'clock-es', lang: 'en-US' ,tz: 'Europe/Madrid', lb: 'Espanha' },
            { id: 'clock-br', lang: 'pt-BR' ,tz: 'America/Sao_Paulo', lb: 'Brasil' },
            { id: 'clock-cl', lang: 'en-US' ,tz: 'America/Santiago', lb: 'Chile' },
            { id: 'clock-co', lang: 'en-US' ,tz: 'America/Bogota', lb: 'Colombia' },
            { id: 'clock-pe', lang: 'en-US' ,tz: 'America/Lima', lb: 'Perú' },
            { id: 'clock-ar', lang: 'en-US' ,tz: 'America/Argentina/Buenos_Aires', lb: 'Argentina' }
        ];



        function createAnalogClock(canvasId, timeZone, lang) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext("2d");
            const radius = canvas.height / 2;
            ctx.translate(radius, radius);

            function drawClock() {
                drawFace(ctx, radius);
                drawNumbers(ctx, radius);
                drawTimeSmooth(ctx, radius);
                requestAnimationFrame(drawClock);
            }

            function getLocalDate() {
                const now = new Date();
                const localeString = now.toLocaleString(lang, { timeZone });
                return new Date(localeString);
            }

            function drawTimeSmooth(ctx, radius) {
                const now = getLocalDate();
                const ms = now.getMilliseconds();
                const sec = now.getSeconds() + ms / 1000;
                const min = now.getMinutes() + sec / 60;
                const hr = (now.getHours() % 12) + min / 60;

                drawHand(ctx, (hr * Math.PI) / 6, radius * 0.5, 6);
                drawHand(ctx, (min * Math.PI) / 30, radius * 0.75, 4);
                drawHand(ctx, (sec * Math.PI) / 30, radius * 0.85, 2);
            }

            function drawFace(ctx, radius) {
                ctx.beginPath();
                ctx.arc(0, 0, radius * 0.95, 0, 2 * Math.PI);
                ctx.fillStyle = "white";
                ctx.fill();
                ctx.strokeStyle = "#aaa";
                ctx.lineWidth = 4;
                ctx.stroke();

                ctx.beginPath();
                ctx.arc(0, 0, 6, 0, 2 * Math.PI);
                ctx.fillStyle = "#333";
                ctx.fill();
            }

            function drawNumbers(ctx, radius) {
                ctx.font = radius * 0.14 + "px -apple-system, sans-serif";
                ctx.textBaseline = "middle";
                ctx.textAlign = "center";
                for (let num = 1; num <= 12; num++) {
                    let ang = num * Math.PI / 6;
                    ctx.rotate(ang);
                    ctx.translate(0, -radius * 0.78);
                    ctx.rotate(-ang);
                    ctx.fillText(num, 0, 0);
                    ctx.rotate(ang);
                    ctx.translate(0, radius * 0.78);
                    ctx.rotate(-ang);
                }
            }

            function drawHand(ctx, pos, length, width) {
                ctx.beginPath();
                ctx.lineWidth = width;
                ctx.lineCap = "round";
                ctx.moveTo(0, 0);
                ctx.rotate(pos);
                ctx.lineTo(0, -length);
                ctx.stroke();
                ctx.rotate(-pos);
            }

            requestAnimationFrame(drawClock);
        }

        function createDigitalClock(containerId, timeZone, labelText) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const digitalDiv = document.createElement('div');
            digitalDiv.className = 'digital-clock';
            const digitalLabel = document.createElement('div');
            digitalLabel.className = labelText == 'Portugal' || labelText == 'Espanha' ? 'labelbig' : 'label';
            digitalLabel.textContent = labelText;
            container.appendChild(digitalDiv);
            container.appendChild(digitalLabel);

            function updateClock() {
                const now = new Date();
                const localeString = now.toLocaleString("en-US", { timeZone });
                const date = new Date(localeString);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                digitalDiv.textContent = `${hours} : ${minutes}`;
                requestAnimationFrame(updateClock);
            }
            updateClock();
        }
        function createClocks() {
            countries.forEach(c => {
                const containerId = c.id + 'Container';
                if (isDigital) createDigitalClock(containerId, c.tz, c.lb, c.lang);
                else createAnalogClock(c.id, c.tz);
            });
        }
        createClocks();

        function portugalClick() {
            var newUrl = "";
            var currentUrl = window.location.href.toString();
            if (isDigital) {
                if (currentUrl.indexOf('digital=1') === -1) {
                    if (currentUrl.indexOf('?') === -1)
                        currentUrl += '?digital=1';
                    else
                        currentUrl += '&digital=1';
                }
                newUrl = currentUrl.replace('digital=1', 'digital=0');
            }
            else {
                if (currentUrl.indexOf('digital=0') === -1) {
                    if (currentUrl.indexOf('?') === -1)
                        currentUrl += '?digital=0';
                    else
                        currentUrl += '&digital=0';
                }
                newUrl = currentUrl.replace('digital=0', 'digital=1');
            }
            console.log(newUrl);
            window.location = newUrl;
        }
        function spainClick() {
            var newUrl = "";
            var currentUrl = window.location.href.toString();
            if (isDarkMode) {
                if (currentUrl.indexOf('darkMode=1') === -1) {
                    if (currentUrl.indexOf('?') === -1)
                        currentUrl += '?darkMode=1';
                    else
                        currentUrl += '&darkMode=1';
                }
                newUrl = window.location.href.toString().replace('darkMode=1', 'darkMode=0');
            }
            else {
                if (currentUrl.indexOf('darkMode=0') === -1) {
                    if (currentUrl.indexOf('?') === -1)
                        currentUrl += '?darkMode=0';
                    else
                        currentUrl += '&darkMode=0';
                }
                newUrl = currentUrl.replace('darkMode=0', 'darkMode=1');
            }
            console.log(newUrl);
            window.location = newUrl;
            reload();
        }

        /********** Data **********/
        function updateDateBox() {
            const dateBox = document.getElementById("dateBox");
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' };
            dateBox.textContent = now.toLocaleDateString('pt-PT', options);
        }
        updateDateBox();

        /********** Clima **********/
        async function updateWeather() {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Maia,PT&appid=${apiKeyWeather}&units=metric&lang=pt`);
                const data = await res.json();
                if (data.cod === 200) {
                    const temp = Math.round(data.main.temp);
                    const desc = data.weather[0].description;
                    const icon = data.weather[0].icon;
                    weatherBox.innerHTML = `
                    <div><img class="climad" src="http://openweathermap.org/img/wn/${icon}.png"></div>
                    <div>Maia: ${temp}°C</div>
                `;
                } else weatherBox.textContent = 'Não foi possível obter o clima';
            } catch (err) {
                weatherBox.textContent = 'Erro ao obter o clima';
            }
        }
        updateWeather();

        function videoClick() {
            const currentUrl = window.location.href.toString();
            let newUrl = "";
            if (showVideo) {
                if (currentUrl.indexOf('showVideo=1') === -1) {
                    if (currentUrl.indexOf('?') === -1)
                        currentUrl += '?showVideo=1';
                    else
                        currentUrl += '&showVideo=1';
                }
                newUrl = currentUrl.replace('showVideo=1', 'showVideo=0');
            }
            else {
                if (currentUrl.indexOf('showVideo=0') === -1) {
                    if (currentUrl.indexOf('?') === -1)
                        currentUrl += '?showVideo=0';
                    else
                        currentUrl += '&showVideo=0';
                }
                newUrl = currentUrl.replace('showVideo=0', 'showVideo=1');
            }
            console.log(newUrl);
            window.location = newUrl;
        }

        if (showVideo) {
            document.getElementById("videoDiv").style.display = "block";
            document.querySelector(".showClocks").style.display = "none";
        } else {
            document.getElementById("videoDiv").style.display = "none";
            document.querySelector(".showClocks").style.display = "block";
        }
        function chileClick() {
            const currentUrl = window.location.href.toString();
            let newUrl = "";
            if (showVideo) {
                if (currentUrl.indexOf('showVideo=1') === -1) {
                    if (currentUrl.indexOf('?') === -1)
                        currentUrl += '?showVideo=1';
                    else
                        currentUrl += '&showVideo=1';
                }
                newUrl = currentUrl.replace('showVideo=1', 'showVideo=0');
            }
            else {
                if (currentUrl.indexOf('showVideo=0') === -1) {
                    if (currentUrl.indexOf('?') === -1)
                        currentUrl += '?showVideo=0';
                    else
                        currentUrl += '&showVideo=0';
                }
                newUrl = currentUrl.replace('showVideo=0', 'showVideo=1');
            }
            console.log(newUrl);
            window.location = newUrl;
            reload();
        }


        setInterval(updateWeather, 600000);

       
        /********** ETA via Cloudflare Worker **********/
        async function updateETA() {
            try {
                const googleAPIKey = urlParams.get('apiKeyGoogle');
                const res = await fetch("https://muddy-sky-8ac4.igorsantos0409.workers.dev/?key=" + googleAPIKey);
                const data = await res.json();

                if (data.eta_com_transito) {
                    document.getElementById("eta").textContent = `ETA: ${data.eta_com_transito}`;
                } else {
                    document.getElementById("eta").textContent = "ETA: indisponível";
                }
            } catch (err) {
                document.getElementById("eta").textContent = "ETA: erro";
            }
        }

        updateETA();
        setInterval(updateETA, 60000);
    </script>


</body>

</html>


